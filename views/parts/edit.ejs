<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container py-5 animate-fade-in">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                <div class="card-header bg-emerald-gradient text-white py-4 border-0 text-center">
                    <h3 class="mb-0 fw-bold">
                        <i class="fas fa-file-pen me-2"></i>Perbarui Data Barang
                    </h3>
                    <p class="mb-0 opacity-75 small mt-1">Mengedit: <strong><%= part.name %></strong></p>
                </div>

                <div class="card-body p-4 p-md-5 bg-white">
                    <form action="/api/parts/<%= part._id %>?_method=PUT" method="POST" id="formEditPart" enctype="multipart/form-data">
                        <div class="row g-4 mb-4">
                            <div class="col-md-8">
                                <label class="form-label small fw-bold text-muted text-uppercase">Nama Suku Cadang</label>
                                <div class="input-group shadow-sm border rounded-3 overflow-hidden">
                                    <span class="input-group-text bg-white border-0"><i class="fas fa-tag text-success"></i></span>
                                    <input type="text" name="name" class="form-control border-0 py-2" value="<%= part.name %>" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted text-uppercase">Kode</label>
                                <div class="input-group shadow-sm border rounded-3 overflow-hidden">
                                    <span class="input-group-text bg-white border-0"><i class="fas fa-barcode text-success"></i></span>
                                    <input type="text" name="code" class="form-control border-0 py-2" value="<%= part.code %>" required>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label small fw-bold text-muted text-uppercase">Foto Suku Cadang</label>
                                <div id="drop-zone" class="drop-zone rounded-4 border-2 border-dashed d-flex flex-column align-items-center justify-content-center p-4 bg-light">
                                    
                                    <div class="drop-zone-content text-center <%= part.imageUrl ? 'd-none' : '' %>" id="drop-zone-content">
                                        <i class="fas fa-cloud-arrow-up fa-3x text-success mb-3"></i>
                                        <h6 class="fw-bold text-dark">Ganti Foto Suku Cadang</h6>
                                        <p class="text-muted small">Tarik foto baru ke sini</p>
                                    </div>

                                    <input type="file" name="partImage" id="partImage" class="d-none" accept="image/*">
                                    
                                    <div id="preview-container" class="mt-2 <%= part.imageUrl ? '' : 'd-none' %> text-center">
                                        <img id="image-preview" src="<%= part.imageUrl ? part.imageUrl : '#' %>" alt="Preview" class="img-fluid rounded-3 shadow-sm border border-3 border-white" style="max-height: 180px;">
                                        <div class="mt-2">
                                            <p class="small text-muted mb-2 text-italic text-info">Klik area kotak untuk mengganti gambar</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-4 mb-4">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-muted text-uppercase">Stok</label>
                                <div class="input-group shadow-sm border rounded-3 overflow-hidden">
                                    <span class="input-group-text bg-white border-0"><i class="fas fa-boxes-stacked text-success"></i></span>
                                    <input type="number" name="stock" class="form-control border-0 py-2" value="<%= part.stock %>" required>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label small fw-bold text-muted text-uppercase">Supplier</label>
                                <div class="input-group shadow-sm border rounded-3 overflow-hidden">
                                    <span class="input-group-text bg-white border-0"><i class="fas fa-truck text-success"></i></span>
                                    <input type="text" name="supplier" class="form-control border-0 py-2" value="<%= part.supplier %>">
                                </div>
                            </div>
                        </div>

                        <div class="row g-4 mb-5">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Harga Beli</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="number" name="purchasePrice" id="purchasePrice" class="form-control" value="<%= part.purchasePrice %>" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Harga Jual</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="number" name="sellingPrice" id="sellingPrice" class="form-control" value="<%= part.sellingPrice %>" required>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-8">
                                <button type="submit" class="btn btn-success btn-emerald w-100 py-3 fw-bold rounded-3 shadow">
                                    <i class="fas fa-sync-alt me-2"></i>UPDATE DATA SEKARANG
                                </button>
                            </div>
                            <div class="col-md-4">
                                <a href="/parts" class="btn btn-outline-secondary w-100 py-3 fw-bold rounded-3">
                                    BATAL
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Copy JavaScript Logic dari add.ejs (handle dropZone, showPreview)
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('partImage');
    const previewContainer = document.getElementById('preview-container');
    const imagePreview = document.getElementById('image-preview');
    const contentOriginal = document.getElementById('drop-zone-content');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length) { fileInput.files = files; showPreview(files[0]); }
    });

    fileInput.addEventListener('change', () => { if (fileInput.files.length) showPreview(fileInput.files[0]); });

    function showPreview(file) {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.src = e.target.result;
            previewContainer.classList.remove('d-none');
            contentOriginal.classList.add('d-none');
        };
        reader.readAsDataURL(file);
    }
</script>

<style>
    /* Gunakan Style yang sama dengan add.ejs */
    .bg-emerald-gradient { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
    .drop-zone { cursor: pointer; border: 2px dashed #dee2e6; min-height: 180px; transition: 0.3s; }
    .drop-zone:hover, .drop-zone.drag-over { border-color: #2ecc71; background: rgba(46, 204, 113, 0.05); }
    .btn-emerald { background-color: #2ecc71; border: none; }
</style>