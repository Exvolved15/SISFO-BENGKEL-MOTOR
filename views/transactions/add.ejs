<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<div class="container-fluid px-4 py-4 animate-fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 fw-bold text-dark mb-0"><i class="fas fa-cash-register text-success me-2"></i>Transaksi Baru</h1>
        <a href="/transactions" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
            <i class="fas fa-history me-1"></i> Batal & Kembali
        </a>
    </div>

    <form id="transactionForm">
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-dark text-white py-3 rounded-top-4">
                        <h6 class="mb-0 small fw-bold text-uppercase"><i class="fas fa-user-tag me-2"></i>Informasi Pelanggan</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Nama Pelanggan</label>
                            <select name="customer" id="customerSelect" class="form-select border-0 bg-light py-2" required>
                                <option value="">-- Pilih Pelanggan --</option>
                                <% if (typeof users !== 'undefined' && users.length > 0) { %>
                                    <% users.forEach(cust => { %>
                                        <option value="<%= cust._id %>"><%= cust.name %></option>
                                    <% }) %>
                                <% } %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Tipe Motor</label>
                            <select name="motorName" id="motorSelect" class="form-select border-0 bg-light py-2" required>
                                <option value="">-- Pilih Motor --</option>
                                <% motors.forEach(m => { %>
                                    <option value="<%= m.name %>"><%= m.brand %> - <%= m.name %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="mb-0">
                            <label class="form-label small fw-bold text-muted text-uppercase">Nomor Polisi</label>
                            <input type="text" class="form-control border-0 bg-light py-2 font-monospace" id="vehicleLicense" name="vehicleLicense" placeholder="B 1234 ABC" required>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-emerald-gradient text-white py-3 rounded-top-4">
                        <h6 class="mb-0 small fw-bold text-uppercase"><i class="fas fa-cog me-2"></i>Penugasan & Bayar</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Mekanik (Opsional)</label>
                            <select class="form-select border-0 bg-light py-2" id="assignedTo">
                                <option value="">-- Langsung Bayar (Tanpa Mekanik) --</option>
                                <% if (typeof mechanics !== 'undefined' && mechanics.length > 0) { %>
                                    <% mechanics.forEach(mech => { %>
                                        <option value="<%= mech._id %>"><%= mech.name %></option>
                                    <% }) %>
                                <% } %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Metode Pembayaran</label>
                            <select class="form-select border-0 bg-light py-2" id="paymentMethod" onchange="togglePaymentInstructions()">
                                <option value="Cash">Tunai / Cash</option>
                                <option value="Transfer">Transfer Bank</option>
                                <option value="QRIS">QRIS / E-Wallet</option>
                            </select>
                        </div>

                        <div id="paymentInstructions" class="mb-3 d-none">
    <div class="card border-0 bg-white shadow-sm rounded-4 border-start border-5 border-success overflow-hidden">
        <div class="card-body p-3">
            
            <div id="transferInfo" class="mb-3">
                <p class="small fw-bold mb-2 text-dark text-uppercase" style="font-size: 0.7rem;">
                    <i class="fas fa-university me-1 text-success"></i> Transfer Rekening (Manual)
                </p>
                <div class="bg-light p-2 rounded-3 d-flex justify-content-between align-items-center mb-1 border">
                    <div>
                        <span class="d-block small text-muted" style="font-size: 0.6rem;">BANK BCA</span>
                        <span class="font-monospace fw-bold">1234567890</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-white border shadow-sm" onclick="copyToClipboard('1234567890')">
                        <i class="far fa-copy text-primary"></i>
                    </button>
                </div>
                <p class="small text-muted mb-0" style="font-size: 0.65rem;">a.n ACR Bengkel Jaya</p>
            </div>

            <hr class="my-3 opacity-25">

            <div id="vaInfo" class="mb-3">
                <p class="small fw-bold mb-2 text-dark text-uppercase" style="font-size: 0.7rem;">
                    <i class="fas fa-robot me-1 text-primary"></i> Virtual Account (Otomatis)
                </p>
                <div class="d-flex gap-1 mb-2">
                    <button type="button" class="btn btn-xs btn-outline-primary active py-1 px-2 small" style="font-size: 0.7rem;" onclick="selectVABank('BCA', '88770812345678', this)">BCA</button>
                    <button type="button" class="btn btn-xs btn-outline-primary py-1 px-2 small" style="font-size: 0.7rem;" onclick="selectVABank('Mandiri', '901230812345678', this)">Mandiri</button>
                </div>
                <div class="bg-primary bg-opacity-10 p-2 rounded-3 border border-primary border-opacity-25">
                    <div class="d-flex justify-content-between align-items-center bg-white p-2 rounded shadow-sm border">
                        <span class="font-monospace fw-bold text-dark mb-0" id="vaNumberDisplay">88770812345678</span>
                        <i class="far fa-copy text-primary" style="cursor:pointer" onclick="copyToClipboard(currentVA)"></i>
                    </div>
                </div>
            </div>

            <div id="qrisInfo" class="d-none text-center">
                <p class="small fw-bold mb-2 text-dark text-start text-uppercase" style="font-size: 0.7rem;">
                    <i class="fas fa-qrcode me-1 text-danger"></i> Scan QRIS ACR Motor
                </p>
                <div class="bg-white p-2 border rounded-3 shadow-sm d-inline-block">
                    <img id="qrisImage" src="" alt="QR Code" class="img-fluid" style="max-height: 150px;">
                </div>
                <p class="small text-muted mt-2 mb-0" style="font-size: 0.65rem;">Berlaku untuk semua E-Wallet</p>
            </div>

        </div>
    </div>
                        </div>
                        <div class="mb-0">
                            <label class="form-label small fw-bold text-muted text-uppercase">Catatan Transaksi</label>
                            <textarea class="form-control border-0 bg-light" id="notes" rows="2" placeholder="Catatan tambahan..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                    <div class="card-header bg-white py-3 border-bottom border-light">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-box text-muted"></i></span>
                                    <select class="form-select border-0 bg-light" id="partSelect">
                                        <option value="" selected disabled>Pilih Suku Cadang...</option>
                                        <% if (typeof parts !== 'undefined') { %>
                                            <% parts.forEach(part => { %>
                                                <option value="<%= part._id %>" data-name="<%= part.name %>" data-price="<%= part.sellingPrice || part.price %>" data-code="<%= part.code %>" data-stock="<%= part.stock %>">
                                                    <%= part.name %> (<%= part.stock %>) - Rp<%= part.sellingPrice.toLocaleString() %>
                                                </option>
                                            <% }) %>
                                        <% } %>
                                    </select>
                                    <button class="btn btn-success" type="button" onclick="addItem('part')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-wrench text-muted"></i></span>
                                    <select class="form-select border-0 bg-light" id="serviceSelect">
                                        <option value="" selected disabled>Pilih Jasa Servis...</option>
                                        <% if (typeof services !== 'undefined') { %>
                                            <% services.forEach(srv => { %>
                                                <option value="<%= srv._id %>" data-name="<%= srv.name %>" data-code="<%= srv.code %>" data-price="<%= srv.price %>">
                                                    <%= srv.name %> - Rp<%= srv.price.toLocaleString() %>
                                                </option>
                                            <% }) %>
                                        <% } %>
                                    </select>
                                    <button class="btn btn-info text-white" type="button" onclick="addItem('service')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive" style="min-height: 300px;">
                        <table class="table table-hover align-middle mb-0" id="cartTable">
                            <thead class="table-light">
                                <tr class="small fw-bold text-muted text-uppercase">
                                    <th class="ps-4">Item & Deskripsi</th>
                                    <th class="text-end">Harga</th>
                                    <th class="text-center" style="width:120px;">Qty</th>
                                    <th class="text-end">Subtotal</th>
                                    <th class="text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="text-center py-5 text-muted small italic">Belum ada item ditambahkan.</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card-footer bg-light p-4">
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <div class="mb-0" style="max-width: 200px;">
                                    <label class="form-label small fw-bold text-muted text-uppercase">Diskon Member (%)</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control border-0" id="discountPercent" value="0" min="0" max="100" onchange="renderCart()">
                                        <span class="input-group-text bg-white border-0">%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <p class="text-muted mb-1 small text-uppercase fw-bold">Grand Total</p>
                                <h2 class="fw-bold text-success font-monospace mb-0" id="displayTotal">Rp 0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-success btn-emerald btn-lg w-100 rounded-4 py-3 shadow-lg fw-bold" id="btnSubmit">
                    <i class="fas fa-check-double me-2"></i> SELESAIKAN & CETAK INVOICE
                </button>
            </div>
        </div>
    </form>
</div>

<style>
    .bg-emerald-gradient { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
    .btn-emerald { background-color: #2ecc71; border: none; transition: all 0.3s ease; }
    .btn-emerald:hover { background-color: #27ae60; transform: translateY(-3px); box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3); }
    .font-monospace { font-family: 'Courier New', Courier, monospace; letter-spacing: 1px; }
    .shadow-inner { box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.05); }
    .animate-fade-in { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>



<script>
    let cart = [];
    let currentVA = "88770812345678";

    // Fungsi Tambah Barang/Jasa
    function addItem(type) {
        const selectId = (type === 'part') ? 'partSelect' : 'serviceSelect';
        const selectElement = document.getElementById(selectId);
        const selectedOption = selectElement.options[selectElement.selectedIndex];

        if (!selectedOption || !selectedOption.value) return;

        const itemId = selectedOption.value;
        const name = selectedOption.getAttribute('data-name');
        const price = parseInt(selectedOption.getAttribute('data-price')) || 0;
        const itemCode = selectedOption.getAttribute('data-code') || 'UNK-001'; 
        const stock = parseInt(selectedOption.getAttribute('data-stock')) || 0;

        const existingItem = cart.find(i => i.itemId === itemId);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({
                itemId, itemType: type, name, itemCode,
                pricePerUnit: price, quantity: 1, stock: stock
            });
        }
        renderCart();
    }

    // Render Tabel Keranjang
    function renderCart() {
        const tbody = document.querySelector("#cartTable tbody");
        const displayTotal = document.getElementById("displayTotal");
        tbody.innerHTML = "";
        let totalKotor = 0;

        if (cart.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted small italic">Belum ada item.</td></tr>';
            displayTotal.innerText = "Rp 0";
            return;
        }

        cart.forEach((item, index) => {
            const subtotal = item.quantity * item.pricePerUnit;
            totalKotor += subtotal;
            tbody.innerHTML += `
                <tr>
                    <td class="ps-4">
                        <div class="fw-bold text-dark">${item.name}</div>
                        <small class="badge bg-light text-muted border font-monospace">${item.itemCode}</small>
                    </td>
                    <td class="text-end">Rp ${item.pricePerUnit.toLocaleString('id-ID')}</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQty(${index}, ${item.quantity - 1})">-</button>
                            <input type="number" value="${item.quantity}" class="form-control text-center border-0 bg-light" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQty(${index}, ${item.quantity + 1})">+</button>
                        </div>
                    </td>
                    <td class="text-end fw-bold text-success">Rp ${subtotal.toLocaleString('id-ID')}</td>
                    <td class="text-center">
                        <button type="button" onclick="removeItem(${index})" class="btn btn-link text-danger p-0"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });

        const discPercent = parseInt(document.getElementById("discountPercent").value) || 0;
        const finalTotal = totalKotor - (totalKotor * discPercent / 100);
        displayTotal.innerText = "Rp " + finalTotal.toLocaleString('id-ID');
        
        if (document.getElementById('paymentMethod').value === 'QRIS') updateQR(finalTotal);
    }

    // 1. Fungsi Switcher Pembayaran
    function togglePaymentInstructions() {
        const method = document.getElementById('paymentMethod').value;
        const box = document.getElementById('paymentInstructions');
        const transfer = document.getElementById('transferInfo');
        const va = document.getElementById('vaInfo');
        const qris = document.getElementById('qrisInfo');

        box.classList.add('d-none');
        transfer.classList.add('d-none');
        va.classList.add('d-none');
        qris.classList.add('d-none');

        if (method === 'Transfer') {
            box.classList.remove('d-none');
            transfer.classList.remove('d-none'); // Munculkan Rekening
            va.classList.remove('d-none');       // Munculkan VA juga
        } else if (method === 'QRIS') {
            box.classList.remove('d-none');
            qris.classList.remove('d-none');
            const total = document.getElementById('displayTotal').innerText.replace(/[^0-9]/g, '');
            updateQR(total);
        }
    }

    // 2. Logika QRIS API
    function updateQR(amount) {
        const qrisImg = document.getElementById('qrisImage');
        if (qrisImg) {
            const qrData = `ACRMOTOR-INV-${Date.now()}-AMT-${amount}`;
            qrisImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;
        }
    }

    // 3. Logika Virtual Account
    function selectVABank(bank, number, btn) {
        document.getElementById('vaNumberDisplay').innerText = number;
        currentVA = number;
        const buttons = document.querySelectorAll('#vaInfo .btn');
        buttons.forEach(b => b.classList.remove('active', 'btn-primary'));
        buttons.forEach(b => b.classList.add('btn-outline-primary'));
        btn.classList.add('active', 'btn-primary');
        btn.classList.remove('btn-outline-primary');
    }

    // 4. Helper Copy dengan proteksi Swal
    function copyToClipboard(val) {
        if(!val) val = currentVA;
        navigator.clipboard.writeText(val);
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'success', title: 'Tersalin!', text: val, timer: 1000,
                showConfirmButton: false, toast: true, position: 'top-end'
            });
        } else {
            alert('Tersalin: ' + val);
        }
    }

    function updateQty(index, val) {
        if (cart[index].itemType === 'part' && val > cart[index].stock) return alert('Stok tidak cukup');
        cart[index].quantity = Math.max(1, parseInt(val) || 1);
        renderCart();
    }

    function removeItem(index) {
        cart.splice(index, 1);
        renderCart();
    }

    // FORM SUBMIT
    

    document.getElementById('transactionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // 1. Validasi Keranjang
    if (cart.length === 0) {
        return Swal.fire('Error', 'Keranjang belanja masih kosong!', 'error');
    }

    const btn = document.getElementById('btnSubmit');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> MEMPROSES...';

    // 2. Hitung Total & Diskon
    const totalKotor = cart.reduce((sum, item) => sum + (item.quantity * item.pricePerUnit), 0);
    const discPercent = parseInt(document.getElementById("discountPercent").value) || 0;
    const discAmount = (totalKotor * discPercent) / 100;
    const finalAmount = totalKotor - discAmount;

    // 3. AMBIL DATA DARI INPUT (PASTIKAN ID SESUAI)
    const paymentMethodValue = document.getElementById('paymentMethod').value; // MENGAMBIL NILAI TERBARU

    const formData = {
        customer: document.getElementById('customerSelect').value,
        motorName: document.getElementById('motorSelect').value,
        vehicleLicense: document.getElementById('vehicleLicense').value,
        totalAmount: finalAmount,
        discount: discAmount,
        paymentMethod: paymentMethodValue, // DATA INI YANG DIKIRIM KE DB
        notes: document.getElementById('notes').value || '-',
        assignedTo: document.getElementById('assignedTo').value || null,
        itemDetails: JSON.stringify(cart)
    };

    try {
        const response = await fetch('/api/transactions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            Swal.fire({
                icon: 'success',
                title: 'Transaksi Berhasil!',
                text: 'Data telah disimpan ke database.',
                timer: 2000,
                showConfirmButton: false
            }).then(() => {
                window.location.href = '/transactions';
            });
        } else {
            Swal.fire('Gagal!', result.message || 'Terjadi kesalahan.', 'error');
            btn.disabled = false;
            btn.innerHTML = 'SELESAIKAN & CETAK INVOICE';
        }
    } catch (err) { 
        console.error(err);
        Swal.fire('Error', 'Gagal menghubungkan ke server.', 'error');
        btn.disabled = false;
        btn.innerHTML = 'SELESAIKAN & CETAK INVOICE';
    }
});
    document.addEventListener('DOMContentLoaded', () => {
        togglePaymentInstructions();
    });
</script>