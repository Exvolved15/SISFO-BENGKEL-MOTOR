<% 
    let activeJob = null; let pendingJobs = []; let completedJobs = [];
    if (typeof historyJobs !== 'undefined' && Array.isArray(historyJobs)) {
        activeJob = historyJobs.find(j => j.status === 'on_progress');
        pendingJobs = historyJobs.filter(j => j.status === 'pending');
        completedJobs = historyJobs.filter(j => j.status === 'completed');
    }
%>
<div class="container-fluid py-4">
    <div class="card border-0 shadow-sm mb-4 card-hover" style="border-radius: 15px;">
        <div class="card-body d-flex align-items-center p-4">
            <div class="rounded-circle bg-warning overflow-hidden shadow-sm" style="width: 80px; height: 80px;">
                <img src="<%= user.profileImage %>?t=<%= Date.now() %>" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <div class="ms-4">
                <h3 class="fw-bold mb-1"><%= user.name %></h3>
                <% if (activeJob) { %>
                    <span class="badge bg-danger pulse"><i class="fas fa-tools fa-spin me-1"></i>SEDANG SIBUK</span>
                <% } else { %>
                    <span class="badge bg-success">SIAP BEKERJA</span>
                <% } %>
            </div>
            <div class="ms-auto text-end border-start ps-4">
                <small class="text-muted d-block">Otoritas</small>
                <span class="fw-bold text-primary">Technical & Parts</span>
                <a href="/users/edit/<%= user._id %>" class="btn btn-sm btn-outline-dark d-block mt-2 btn-hover">Edit Profil</a>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4 card-hover">
                <div class="card-header bg-dark text-white">Pekerjaan Berjalan</div>
                <div class="card-body p-4">
                    <% if (activeJob) { %>
                        <h4 class="text-primary fw-bold">#<%= activeJob.invoiceNumber %></h4>
                        <p class="mb-1"><%= activeJob.motorName %> - <strong><%= activeJob.vehicleLicense %></strong></p>
                        <div class="alert alert-secondary mt-3"><%= activeJob.description %></div>
                        <button onclick="finishWork('<%= activeJob._id %>')" class="btn btn-success w-100 py-3 fw-bold btn-hover">SELESAIKAN PEKERJAAN</button>
                    <% } else { %>
                        <p class="text-center text-muted py-4">Belum ada pekerjaan aktif.</p>
                    <% } %>
                </div>
            </div>

            <div class="card border-0 shadow-sm card-hover">
                <div class="card-header bg-secondary text-white">Antrean Menunggu</div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <tbody>
                            <% pendingJobs.forEach(job => { %>
                                <tr>
                                    <td class="ps-3"><strong><%= job.invoiceNumber %></strong></td>
                                    <td><%= job.motorName %></td>
                                    <td class="text-end pe-3"><button onclick="startJob('<%= job._id %>')" class="btn btn-sm btn-primary btn-hover">Mulai</button></td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm card-hover h-100">
                <div class="card-header bg-success text-white">Riwayat Hari Ini</div>
                <div class="list-group list-group-flush">
                    <% completedJobs.forEach(job => { %>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div><small class="text-primary fw-bold">#<%= job.invoiceNumber %></small><br><%= job.motorName %></div>
                            <a href="/jobs/detail/<%= job._id %>" class="btn btn-xs btn-outline-primary btn-hover"><i class="fas fa-eye"></i></a>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>
    </div>
</div>