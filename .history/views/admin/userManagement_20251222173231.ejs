<script>
    const API_URL = '/api/users';
    
    // --- 1. READ (Mengambil Semua User) ---
    async function fetchUsers() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();

            if (response.ok) {
                renderUserTable(data.data);
            } else {
                console.error('Gagal memuat user:', data.message);
                alert('Gagal memuat data karyawan.');
            }
        } catch (error) {
            console.error('Network Error:', error);
            alert('Terjadi kesalahan jaringan saat memuat data.');
        }
    }

    // Fungsi untuk menampilkan data di tabel EJS
    function renderUserTable(users) {
        const tableBody = document.getElementById('userTableBody');
        tableBody.innerHTML = ''; // Bersihkan tabel lama

        users.forEach(user => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${user._id}</td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.role}</td>
                <td>
                    <strong><%= u.name %></strong><br>
                    <small class="text-muted"><i class="fas fa-building me-1"></i><%= u.department || '-' %></small>
                </td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="showUpdateForm('${user._id}', '${user.name}', '${user.email}', '${user.role}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${user._id}')">Hapus</button>
                </td>
            `;
        });
    }

    // --- 2. CREATE (Membuat User Baru) ---
    async function createUser(event) {
        event.preventDefault();
        const form = event.target;
        const newUser = {
            name: form.name.value,
            email: form.email.value,
            password: form.password.value,
            role: form.role.value,
        };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newUser)
            });

            const data = await response.json();

            if (response.ok) {
                alert(data.message);
                form.reset();
                fetchUsers(); // Refresh tabel
            } else {
                alert(`Gagal membuat user: ${data.message}`);
            }
        } catch (error) {
            alert('Terjadi kesalahan jaringan saat membuat user.');
        }
    }

    // --- 3. DELETE (Menghapus User) ---
    async function deleteUser(userId) {
        if (!confirm('Anda yakin ingin menghapus karyawan ini? Tindakan ini tidak dapat dibatalkan.')) {
            return;
        }

        try {
            const response = await fetch(`${API_URL}/${userId}`, {
                method: 'DELETE'
            });

            if (response.status === 204 || response.ok) {
                alert('Karyawan berhasil dihapus.');
                fetchUsers(); // Refresh tabel
            } else {
                const data = await response.json();
                alert(`Gagal menghapus user: ${data.message}`);
            }
        } catch (error) {
            alert('Terjadi kesalahan jaringan saat menghapus user.');
        }
    }

    // --- INISIASI: Panggil saat halaman dimuat ---
    document.addEventListener('DOMContentLoaded', fetchUsers);
    
    // Hubungkan form create user
    const createForm = document.getElementById('createUserForm');
    if (createForm) {
        createForm.addEventListener('submit', createUser);
    }
</script>