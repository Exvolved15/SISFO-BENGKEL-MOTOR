<body class="bg-login-gradient min-vh-100 d-flex align-items-center">
    <div class="container py-5">
        <div class="row justify-content-center w-100 m-0"> <div class="col-md-6 col-lg-4">
                <div class="card border-0 shadow-lg p-4 login-card animate-fade-in">
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <div class="icon-shape bg-success bg-opacity-10 text-success rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center shadow-sm" style="width: 70px; height: 70px;">
                                <i class="fas fa-screwdriver-wrench fa-2x"></i>
                            </div>
                            <h3 class="fw-bold text-dark mb-1">SISFO BENGKEL</h3>
                            <p class="text-muted small">Silakan masuk ke akun Anda</p>
                        </div>

                        <% if (locals.query && query.success) { %>
                            <div class="alert alert-success alert-dismissible fade show small text-center rounded-3 mb-4" role="alert">
                                <i class="fas fa-check-circle me-1"></i> Registrasi berhasil! Silakan login.
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        <% } %>

                        <div id="errorMessage" class="alert alert-danger d-none small rounded-3 mb-4 border-0 shadow-sm" role="alert"></div>

                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="email" class="form-label small fw-bold text-muted text-uppercase">Alamat Email</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-envelope text-muted"></i></span>
                                    <input type="email" class="form-control border-0 bg-light py-2" id="email" name="email" placeholder="nama@email.com" required autocomplete="username">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="password" class="form-label small fw-bold text-muted text-uppercase">Kata Sandi</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-lock text-muted"></i></span>
                                    <input type="password" class="form-control border-0 bg-light py-2" id="password" name="password" placeholder="••••••••" required autocomplete="current-password">
                                </div>
                            </div>

                            <button type="submit" id="btnLogin" class="btn btn-success w-100 py-2 fw-bold rounded-3 shadow btn-emerald">
                                <span id="btnText">MASUK KE SISTEM</span>
                                <span id="btnLoading" class="d-none"><i class="fas fa-spinner fa-spin me-2"></i>MEMPROSES...</span>
                            </button>
                        </form>

                        <div class="text-center mt-4 pt-2 border-top">
                            <p class="text-muted small mb-0">Belum memiliki akun?</p>
                            <a href="/register" class="text-success fw-bold text-decoration-none small">Buat Akun Baru</a>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <a href="/" class="text-white opacity-75 text-decoration-none small"><i class="fas fa-arrow-left me-1"></i> Kembali ke Beranda</a>
                </div>
            </div> </div> </div> <style>
        .bg-login-gradient {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            position: relative;
            min-height: 100vh;
        }

        .bg-login-gradient::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(#2ecc71 0.5px, transparent 0.5px);
            background-size: 30px 30px;
            opacity: 0.1;
            z-index: 0;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px !important;
            position: relative;
            z-index: 1;
        }

        .btn-emerald {
            background-color: #2ecc71;
            border: none;
            color: white;
        }
        .btn-emerald:hover {
            background-color: #27ae60;
            color: white;
            transform: translateY(-2px);
        }

        .animate-fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"; 
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; 

        const firebaseConfig = {
            apiKey: "AIzaSyBNclQBPgOf9wS0hCM6jsWerAJ_-mz_AOA",
            authDomain: "bengkelan-motor.firebaseapp.com",
            projectId: "bengkelan-motor",
            storageBucket: "bengkelan-motor.firebasestorage.app",
            messagingSenderId: "86184705378",
            appId: "1:86184705378:web:018c12ce6261c9a522c03b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); 

        const loginForm = document.getElementById('loginForm');
        const btnLogin = document.getElementById('btnLogin');
        const btnText = document.getElementById('btnText');
        const btnLoading = document.getElementById('btnLoading');
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMessageDiv = document.getElementById('errorMessage');
            
            errorMessageDiv.classList.add('d-none');
            btnLogin.disabled = true;
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');

            try {
                await signOut(auth);
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const idToken = await userCredential.user.getIdToken(); 

                const res = await fetch('/api/auth/verify-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idToken: idToken }) 
                });

                const data = await res.json();

                if (res.ok) {
                    if (data.user.role === 'mekanik') {
                        window.location.href = '/mechanic/dashboard'; 
                    } else if (data.user.role === 'kasir') {
                        window.location.href = '/kasir/dashboard';
                    } else if (data.user.role === 'admin') {
                        window.location.href = '/admin/dashboard';
                    } else {
                        window.location.href = '/customer/dashboard';
                    }
                } else {
                    throw new Error(data.message || 'Gagal verifikasi sesi.');
                }

            } catch (error) {
                btnLogin.disabled = false;
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');

                let pesan = error.message;
                if (pesan.includes("auth/invalid-credential")) {
                    pesan = "Email atau Password salah.";
                }
                
                errorMessageDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> ${pesan}`;
                errorMessageDiv.classList.remove('d-none');
            }
        });
    </script>
</body>