<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"; 
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; 

    const firebaseConfig = {
        apiKey: "AIzaSyBNclQBPgOf9wS0hCM6jsWerAJ_-mz_AOA",
        authDomain: "bengkelan-motor.firebaseapp.com",
        projectId: "bengkelan-motor",
        storageBucket: "bengkelan-motor.firebasestorage.app",
        messagingSenderId: "86184705378",
        appId: "1:86184705378:web:018c12ce6261c9a522c03b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); 

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault(); 
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorMessageDiv = document.getElementById('errorMessage');
        
        errorMessageDiv.classList.add('d-none');

        try {
            await signOut(auth); // Bersihkan sesi Firebase lama
            
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const idToken = await userCredential.user.getIdToken(); // Ambil Token Firebase

            // KIRIM KE SERVER
            const res = await fetch('/api/auth/verify-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: idToken }) // FIX: Gunakan idToken, bukan token
            });

            const data = await res.json();

            if (res.ok) {
                // REDIRECT BERDASARKAN ROLE
                if (data.user.role === 'mekanik') {
                    window.location.href = '/api/jobs/mekanik/jobs'; // Dashboard Mekanik
                } else if (data.user.role === 'kasir') {
                    window.location.href = '/kasir/dashboard';
                } else {
                    window.location.href = '/'; 
                }
            } else {
                throw new Error(data.message || 'Verifikasi server gagal.');
            }

        } catch (error) {
            errorMessageDiv.textContent = error.message;
            errorMessageDiv.classList.remove('d-none');
        }
    });
</script>