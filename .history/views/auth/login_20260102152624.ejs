<div class="login-wrapper d-flex align-items-center justify-content-center" style="min-height: 85vh;">
    <div class="container">
        <div class="row justify-content-center w-100 m-0">
            <div class="col-12 col-sm-10 col-md-6 col-lg-4">
                <div class="card border-0 shadow-lg p-4 login-card animate-fade-in">
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <div class="icon-shape bg-success bg-opacity-10 text-success rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 70px; height: 70px;">
                                <i class="fas fa-screwdriver-wrench fa-2x"></i>
                            </div>
                            <h4 class="fw-bold text-dark mb-1">SISFO BENGKEL</h4>
                            <p class="text-muted small">Silakan masuk ke akun Anda</p>
                        </div>

                        <% if (locals.query && query.success) { %>
                            <div class="alert alert-success small text-center rounded-3 mb-4">Registrasi sukses! Silakan login.</div>
                        <% } %>

                        <div id="errorMessage" class="alert alert-danger d-none small rounded-3 mb-4"></div>

                        <form id="loginForm">
                            <div class="mb-3 text-start">
                                <label class="form-label small fw-bold text-muted text-uppercase">Email</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-envelope text-muted"></i></span>
                                    <input type="email" class="form-control border-0 bg-light py-2" id="email" placeholder="nama@email.com" required>
                                </div>
                            </div>
                            <div class="mb-4 text-start">
                                <label class="form-label small fw-bold text-muted text-uppercase">Password</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-lock text-muted"></i></span>
                                    <input type="password" class="form-control border-0 bg-light py-2" id="password" placeholder="••••••••" required>
                                </div>
                            </div>
                            <button type="submit" id="btnLogin" class="btn btn-success w-100 py-2 fw-bold rounded-3 shadow">
                                <span id="btnText">MASUK KE SISTEM</span>
                                <span id="btnLoading" class="d-none"><i class="fas fa-spinner fa-spin me-2"></i>PROSES...</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBNclQBPgOf9wS0hCM6jsWerAJ_-mz_AOA",
        authDomain: "bengkelan-motor.firebaseapp.com",
        projectId: "bengkelan-motor",
        storageBucket: "bengkelan-motor.firebasestorage.app",
        messagingSenderId: "86184705378",
        appId: "1:86184705378:web:018c12ce6261c9a522c03b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const loginForm = document.getElementById('loginForm');
    const btnLogin = document.getElementById('btnLogin');
    const btnText = document.getElementById('btnText');
    const btnLoading = document.getElementById('btnLoading');
    const errorMessageDiv = document.getElementById('errorMessage');

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        // UI Loading
        errorMessageDiv.classList.add('d-none');
        btnLogin.disabled = true;
        btnText.classList.add('d-none');
        btnLoading.classList.remove('d-none');

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const idToken = await userCredential.user.getIdToken();

            // Kirim token ke server untuk verifikasi session EJS
            const res = await fetch('/api/auth/verify-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken })
            });

            const data = await res.json();

            if (res.ok) {
                // Redirect berdasarkan role dari server
                window.location.href = data.redirectUrl || '/dashboard-redirect';
            } else {
                throw new Error(data.message || 'Gagal verifikasi akun di server');
            }
        } catch (error) {
            btnLogin.disabled = false;
            btnText.classList.remove('d-none');
            btnLoading.classList.add('d-none');
            errorMessageDiv.textContent = "Email/Password salah atau masalah koneksi.";
            errorMessageDiv.classList.remove('d-none');
        }
    });
</script>