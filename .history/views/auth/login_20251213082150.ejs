
<script type="module">
    // Pastikan path ini benar (sesuai dengan nama file di public/js)
    import auth from '/js/firebaseAuth.js'; 
    import { signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; 
    
    // Ganti URL import Firebase SDK sesuai versi yang Anda instal jika berbeda
    
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault(); 

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorMessageDiv = document.getElementById('errorMessage');

        errorMessageDiv.textContent = '';
        
        try {
            // 1. Login Sisi Klien di Firebase
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const idToken = await userCredential.user.getIdToken(); // Ambil ID Token
            
            // 2. Kirim Token ke Server Kita (Server Verification)
            const response = await fetch('/api/auth/verify-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: idToken })
            });

            if (!response.ok) {
                const errorData = await response.json();
                // Jika server verifikasi kita menolak (misalnya user tidak ada di MongoDB)
                throw new Error(errorData.message || 'Verifikasi server gagal.');
            }

            // 3. Sukses: Redirect ke dashboard
            window.location.href = '/'; 

        } catch (error) {
            let message = 'Login Gagal: Silakan coba lagi.';
            
            // Tangani error spesifik dari Firebase Auth
            if (error.code === 'auth/invalid-credential') {
                 message = 'Email atau kata sandi salah.';
            } else if (error.message) {
                 message = error.message;
            }
            
            console.error(error);
            errorMessageDiv.textContent = message;
        }
    });
</script>