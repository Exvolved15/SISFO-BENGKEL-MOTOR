// --- FUNGSI BARU: MENCEGAT SUBMIT DAN MENGIRIM JSON ---
document.getElementById('transactionForm').addEventListener('submit', async (e) => {
    e.preventDefault(); // Mencegah pengiriman form default browser
    
    // 1. Kumpulkan Data Pelanggan dan Pembayaran
    const customerName = document.getElementById('customerName').value;
    const vehicleLicense = document.getElementById('vehicleLicense').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const notes = document.getElementById('notes').value;
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const grandTotal = parseFloat(document.getElementById('grandTotalInput').value);

    // Pastikan calculateTotal() sudah dipanggil untuk mengisi TRANSACTION_ITEMS
    calculateTotal(); 

    // 2. Buat Payload Final untuk Server (mengganti req.body)
    const payload = {
        // Data Pelanggan/Kendaraan (Kunci harus sesuai dengan yang di-destructure oleh Controller)
        customerName: customerName, 
        vehicleLicense: vehicleLicense,
        
        // Data Transaksi
        itemDetails: TRANSACTION_ITEMS, // Array item yang dikumpulkan dari tabel
        
        // Data Pembayaran
        paymentMethod: paymentMethod,
        discountAmount: discount,
        totalAmount: grandTotal, // Gunakan grandTotal setelah diskon
        notes: notes,
        
        // Asumsi: Diperlukan penugasan mekanik
        // assignedMekanikId: document.getElementById('assignedMekanik').value, 
    };

    // 3. Kirim permintaan POST ke server sebagai JSON
    try {
        const response = await fetch('/api/jobs', { // Ganti '/api/jobs' jika Anda menggunakan rute '/transactions/add'
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (response.ok) {
            alert(`Transaksi Berhasil! Job ID: ${data.data._id}`);
            // Redirect ke dashboard atau halaman detail job
            window.location.href = '/kasir/dashboard'; 
        } else {
            // Menampilkan pesan error dari server
            alert(`Transaksi Gagal (Kode: ${response.status})\nKesalahan: ${data.message || 'Terjadi kesalahan server.'}`);
        }

    } catch (error) {
        console.error('Network error during transaction:', error);
        alert('Terjadi kesalahan jaringan atau koneksi server terputus.');
    }
});