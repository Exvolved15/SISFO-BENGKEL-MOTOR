<div class="container mt-4">
    <h1><%= title %></h1>

    <div class="row">
        <div class="col-md-12">
            <form id="transactionForm">
                
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">Informasi Pelanggan</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerName" class="form-label">Nama Pelanggan</label>
                                <input type="text" class="form-control" id="customerName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vehicleLicense" class="form-label">Plat Nomor Kendaraan</label>
                                <input type="text" class="form-control" id="vehicleLicense" required placeholder="Contoh: DD 1234 EE">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">Detail Penjualan & Servis</div>
                    <div class="card-body">
                        <table class="table table-bordered" id="itemTable">
                            <thead>
                                <tr>
                                    <th>Item (Suku Cadang/Jasa)</th>
                                    <th style="width: 15%;">Harga Satuan (Rp)</th>
                                    <th style="width: 10%;">Qty</th>
                                    <th style="width: 20%;">Subtotal (Rp)</th>
                                    <th style="width: 5%;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-info text-white me-2" onclick="addItemRow('part')">Tambah Suku Cadang</button>
                            <button type="button" class="btn btn-sm btn-info text-white" onclick="addItemRow('service')">Tambah Jasa Servis</button>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">Penugasan & Pembayaran</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="assignedTo" class="form-label">Tugaskan Mekanik</label>
                                <select class="form-select mb-3" id="assignedTo" name="assignedTo" required>
                                    <option value="">-- Pilih Mekanik --</option>
                                    <% if (typeof mekaniks !== 'undefined' && mekaniks.length > 0) { %>
                                        <% mekaniks.forEach(function(m) { %>
                                            <option value="<%= m._id %>"><%= m.name %></option>
                                        <% }); %>
                                    <% } %>
                                </select>

                                <label for="jobNotes" class="form-label">Work To Do (Instruksi Kerja)</label>
                                <textarea class="form-control mb-3" id="jobNotes" name="notes" rows="3" placeholder="Contoh: Ganti oli, cek rem depan bunyi" required></textarea>
                                
                                <label for="paymentMethod" class="form-label">Metode Pembayaran</label>
                                <select class="form-select" id="paymentMethod" required>
                                    <option value="Cash">Cash</option>
                                    <option value="Transfer">Transfer</option>
                                    <option value="Debit">Debit</option>
                                </select>
                            </div>
                            <div class="col-md-6 text-end">
                                <input type="hidden" id="grandTotalInput" value="0">
                                <h5 class="mt-2">Total Biaya (Bruto): <span id="totalAmountDisplay">Rp 0</span></h5>
                                <h2 class="mt-4">Total Akhir: <span id="grandTotalDisplay" class="text-success">Rp 0</span></h2>
                                
                                <button type="submit" class="btn btn-success btn-lg mt-3" id="submitButton" disabled>Proses Transaksi</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // 1. Inisialisasi Variable
    let cart = [];
    const grandTotalElement = document.getElementById('grandTotalDisplay'); // Pastikan elemen ini ada atau sesuaikan ID-nya
    
    // Fungsi Menambah Item ke Keranjang Sementara (Tabel)
    function addItemToTable(type) {
        // Logika ambil value dari dropdown (sesuaikan ID element dropdown Anda)
        // Asumsi ID dropdown part: 'partSelect', service: 'serviceSelect'
        let selectId = type === 'part' ? 'partSelect' : 'serviceSelect';
        let selectElement = document.getElementById(selectId);
        
        if (!selectElement || selectElement.value === "") {
            alert("Silakan pilih item terlebih dahulu!");
            return;
        }

        // Ambil data dari option yang dipilih (Pastikan di EJS option punya data-price, data-name)
        let selectedOption = selectElement.options[selectElement.selectedIndex];
        let itemId = selectedOption.value;
        let itemName = selectedOption.text;
        let price = parseFloat(selectedOption.getAttribute('data-price') || 0);
        let stock = parseFloat(selectedOption.getAttribute('data-stock') || 0);

        // Cek Stok untuk Part
        if (type === 'part' && stock <= 0) {
            alert("Stok barang ini habis!");
            return;
        }

        // Masukkan ke Array Cart
        cart.push({
            itemId: itemId,
            itemType: type, // PENTING: Kirim type 'part' atau 'service'
            quantity: 1,    // Default 1
            pricePerUnit: price
        });

        renderTable(); // Gambar ulang tabel
    }

    // Fungsi Render Tabel (Sederhana)
    function renderTable() {
        const tbody = document.querySelector("#itemTable tbody"); // Pastikan ID tabel 'itemTable'
        tbody.innerHTML = "";
        let total = 0;

        cart.forEach((item, index) => {
            let subtotal = item.quantity * item.pricePerUnit;
            total += subtotal;
            
            let row = `
                <tr>
                    <td>${item.itemId} (ID)</td>
                    <td>Rp ${item.pricePerUnit}</td>
                    <td><input type="number" value="${item.quantity}" onchange="updateQty(${index}, this.value)" style="width:60px"></td>
                    <td>Rp ${subtotal}</td>
                    <td><button type="button" onclick="removeItem(${index})" class="btn btn-danger btn-sm">X</button></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        // Update Total di Form Input (Hidden)
        document.getElementById('totalAmount').value = total;
        document.getElementById('grandTotal').value = total; // Asumsi tanpa diskon dulu
    }

    // Fungsi Update Qty
    function updateQty(index, newQty) {
        cart[index].quantity = parseInt(newQty);
        renderTable();
    }

    // Fungsi Hapus Item
    function removeItem(index) {
        cart.splice(index, 1);
        renderTable();
    }

    // === INI BAGIAN TERPENTING: PROSES SUBMIT ===
    document.getElementById('transactionForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // 1. Ambil Data Form Utama
        const customerName = document.getElementById('customerName').value;
        const vehicleLicense = document.getElementById('vehicleLicense').value;
        const assignedTo = document.getElementById('assignedTo').value;
        const notes = document.getElementById('notes').value;
        const totalAmount = document.getElementById('totalAmount').value;
        const grandTotal = document.getElementById('grandTotal').value;

        // 2. Validasi Keranjang
        if (cart.length === 0) {
            alert("Keranjang belanja masih kosong!");
            return;
        }

        // 3. Siapkan Payload (Bungkusan Data)
        const payload = {
            customerName,
            vehicleLicense,
            assignedTo, // ID Mekanik (Bisa kosong)
            notes,
            totalAmount,
            grandTotal,
            // Kirim itemDetails sebagai ARRAY OBJECT LANGSUNG (Jangan di-string-kan manual jika fetch support json)
            itemDetails: cart 
        };

        console.log("Mengirim Data:", payload); // Cek di Console Browser (F12)

        try {
            const res = await fetch('/api/transactions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const result = await res.json();

            if (res.ok) {
                alert("Transaksi Berhasil!");
                window.location.href = "/transactions"; // Redirect ke list
            } else {
                alert("Gagal: " + result.message);
                console.error("Server Error:", result);
            }
        } catch (err) {
            alert("Error Koneksi: " + err.message);
        }
    });
</script> 