<!DOCTYPE html>
<html>
<head>
    <title>Struk - <%= transaction.invoiceNumber %></title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; width: 80mm; margin: 0 auto; font-size: 12px; color: #000; }
        .text-center { text-align: center; }
        .line { border-bottom: 1px dashed #000; margin: 5px 0; }
        table { width: 100%; border-collapse: collapse; }
        .item-name { padding-top: 6px; font-weight: bold; }
        .total-row { font-weight: bold; font-size: 14px; }
    </style>
</head>
<body onload="window.print()">
    <div class="text-center">
        <h3 style="margin: 0;">SISFO BENGKEL</h3>
        <p style="margin: 0;">INV: <%= transaction.invoiceNumber %></p>
        <p style="margin: 0;"><%= new Date(transaction.createdAt).toLocaleString('id-ID') %></p>
    </div>

    <div class="line"></div>
    <p style="margin: 4px 0;">Plgn: <%= transaction.customerName %><br>Plat: <%= transaction.vehicleLicense %></p>
    <div class="line"></div>

    <table>
        <% 
            let hitungSubtotal = 0; 
            details.forEach(item => { 
                let totalPerItem = item.quantity * item.pricePerUnit;
                hitungSubtotal += totalPerItem;
        %>
            <tr>
                <td colspan="2" class="item-name"><%= item.itemName %></td>
            </tr>
            <tr>
                <td><%= item.quantity %> x <%= item.pricePerUnit.toLocaleString('id-ID') %></td>
                <td align="right"><%= totalPerItem.toLocaleString('id-ID') %></td>
            </tr>
        <% }) %>
    </table>

    <div class="line"></div>

    <% 
        // LOGIKA PENYELAMAT DISKON
        let grandTotal = transaction.grandTotal || 0;
        
        // Gunakan subtotal dari database, jika 0 gunakan hasil hitung ulang
        let subtotal = (transaction.totalAmount > 0) ? transaction.totalAmount : hitungSubtotal;

        // Jika subtotal masih 0 (karena details kosong), paksa samakan dengan grandTotal
        if (subtotal === 0) subtotal = grandTotal;

        // Hitung nominal diskon (Selisih)
        let diskonNominal = (subtotal > grandTotal) ? (subtotal - grandTotal) : (transaction.discount || 0);
        
        // Hitung persentase
        let persen = subtotal > 0 ? Math.round((diskonNominal / subtotal) * 100) : 0;
    %>

    <table>
        <tr>
            <td>Total:</td>
            <td align="right">Rp <%= subtotal.toLocaleString('id-ID') %></td>
        </tr>
        <tr>
            <td>Diskon (<%= persen %>%):</td>
            <td align="right">- Rp <%= diskonNominal.toLocaleString('id-ID') %></td>
        </tr>
        <tr class="total-row">
            <td style="padding-top: 8px;">TOTAL AKHIR:</td>
            <td align="right" style="padding-top: 8px;">Rp <%= grandTotal.toLocaleString('id-ID') %></td>
        </tr>
    </table>

    <div class="line"></div>
    <div class="text-center" style="margin-top: 10px;">
        <p>Terima Kasih</p>
    </div>
</body>
</html>