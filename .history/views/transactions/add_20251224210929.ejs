<div class="container-fluid px-4 py-4 animate-fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 fw-bold text-dark mb-0"><i class="fas fa-cash-register text-success me-2"></i>Transaksi Baru</h1>
        <a href="/transactions" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
            <i class="fas fa-history me-1"></i> Batal & Kembali
        </a>
    </div>

    <form id="transactionForm">
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-dark text-white py-3 rounded-top-4">
                        <h6 class="mb-0 small fw-bold text-uppercase"><i class="fas fa-user-tag me-2"></i>Informasi Pelanggan</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Nama Pelanggan</label>
                            <select name="customer" id="customerSelect" class="form-select border-0 bg-light py-2" required>
                                <option value="">-- Pilih Pelanggan --</option>
                                <% if (typeof users !== 'undefined' && users.length > 0) { %>
                                    <% users.forEach(cust => { %>
                                        <option value="<%= cust._id %>"><%= cust.name %></option>
                                    <% }) %>
                                <% } %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Tipe Motor</label>
                            <select name="motorName" id="motorSelect" class="form-select border-0 bg-light py-2" required>
                                <option value="">-- Pilih Motor --</option>
                                <% motors.forEach(m => { %>
                                    <option value="<%= m.name %>"><%= m.brand %> - <%= m.name %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="mb-0">
                            <label class="form-label small fw-bold text-muted text-uppercase">Nomor Polisi</label>
                            <input type="text" class="form-control border-0 bg-light py-2 font-monospace" id="vehicleLicense" name="vehicleLicense" placeholder="B 1234 ABC" required>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-emerald-gradient text-white py-3 rounded-top-4">
                        <h6 class="mb-0 small fw-bold text-uppercase"><i class="fas fa-cog me-2"></i>Penugasan & Bayar</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Mekanik (Opsional)</label>
                            <select class="form-select border-0 bg-light py-2" id="assignedTo">
                                <option value="">-- Langsung Bayar (Tanpa Mekanik) --</option>
                                <% if (typeof mechanics !== 'undefined' && mechanics.length > 0) { %>
                                    <% mechanics.forEach(mech => { %>
                                        <option value="<%= mech._id %>"><%= mech.name %></option>
                                    <% }) %>
                                <% } %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Metode Pembayaran</label>
                            <select class="form-select border-0 bg-light py-2" id="paymentMethod">
                                <option value="Cash">Tunai / Cash</option>
                                <option value="Transfer">Transfer Bank</option>
                                <option value="QRIS">QRIS / E-Wallet</option>
                            </select>
                        </div>

                        <div id="paymentDetailArea" class="mt-3 p-3 rounded-4 bg-white border border-2 border-dashed d-none animate-fade-in">
                            <div id="bankInfo" class="d-none">
                                <label class="form-label small fw-bold text-primary text-uppercase mb-2">Rekening Tujuan</label>
                                <div class="p-3 bg-light rounded-3 border-start border-4 border-primary">
                                    <div class="fw-bold text-dark">BANK MANDIRI (ACR MOTOR)</div>
                                    <div class="font-monospace fs-5">123-456-7890-123</div>
                                    <small class="text-muted">Harap lampirkan bukti bayar jika diminta.</small>
                                </div>
                            </div>

                            <div id="qrisInfo" class="text-center d-none">
                                <label class="form-label small fw-bold text-success text-uppercase d-block mb-2">SCAN QRIS PEMBAYARAN</label>
                                <div id="qrcode-container" class="d-inline-block p-2 bg-white shadow-sm rounded-3"></div>
                                <p class="small text-muted mt-2 mb-0 italic">QR otomatis sesuai Grand Total</p>
                            </div>
                        </div>

                        <div class="mb-0 mt-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Catatan Transaksi</label>
                            <textarea class="form-control border-0 bg-light" id="notes" rows="2" placeholder="Catatan tambahan..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                    <div class="card-header bg-white py-3 border-bottom border-light">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-box text-muted"></i></span>
                                    <select class="form-select border-0 bg-light" id="partSelect">
                                        <option value="" selected disabled>Pilih Suku Cadang...</option>
                                        <% if (typeof parts !== 'undefined') { %>
                                            <% parts.forEach(part => { %>
                                                <option value="<%= part._id %>" data-name="<%= part.name %>" data-price="<%= part.sellingPrice || part.price %>" data-code="<%= part.code %>" data-stock="<%= part.stock %>">
                                                    <%= part.name %> (<%= part.stock %>) - Rp<%= part.sellingPrice.toLocaleString() %>
                                                </option>
                                            <% }) %>
                                        <% } %>
                                    </select>
                                    <button class="btn btn-success" type="button" onclick="addItem('part')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-wrench text-muted"></i></span>
                                    <select class="form-select border-0 bg-light" id="serviceSelect">
                                        <option value="" selected disabled>Pilih Jasa Servis...</option>
                                        <% if (typeof services !== 'undefined') { %>
                                            <% services.forEach(srv => { %>
                                                <option value="<%= srv._id %>" data-name="<%= srv.name %>" data-code="<%= srv.code %>" data-price="<%= srv.price %>">
                                                    <%= srv.name %> - Rp<%= srv.price.toLocaleString() %>
                                                </option>
                                            <% }) %>
                                        <% } %>
                                    </select>
                                    <button class="btn btn-info text-white" type="button" onclick="addItem('service')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive" style="min-height: 300px;">
                        <table class="table table-hover align-middle mb-0" id="cartTable">
                            <thead class="table-light">
                                <tr class="small fw-bold text-muted text-uppercase">
                                    <th class="ps-4">Item & Deskripsi</th>
                                    <th class="text-end">Harga</th>
                                    <th class="text-center" style="width:120px;">Qty</th>
                                    <th class="text-end">Subtotal</th>
                                    <th class="text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="text-center py-5 text-muted small italic">Belum ada item ditambahkan.</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card-footer bg-light p-4">
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <div class="mb-0" style="max-width: 200px;">
                                    <label class="form-label small fw-bold text-muted text-uppercase">Diskon Member (%)</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control border-0" id="discountPercent" value="0" min="0" max="100" onchange="renderCart()">
                                        <span class="input-group-text bg-white border-0">%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <p class="text-muted mb-1 small text-uppercase fw-bold">Grand Total</p>
                                <h2 class="fw-bold text-success font-monospace mb-0" id="displayTotal">Rp 0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-success btn-emerald btn-lg w-100 rounded-4 py-3 shadow-lg fw-bold" id="btnSubmit">
                    <i class="fas fa-check-double me-2"></i> SELESAIKAN & CETAK INVOICE
                </button>
            </div>
        </div>
    </form>
</div>

<style>
    .bg-emerald-gradient { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
    .btn-emerald { background-color: #2ecc71; border: none; transition: all 0.3s ease; }
    .btn-emerald:hover { background-color: #27ae60; transform: translateY(-3px); box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3); }
    .font-monospace { font-family: 'Courier New', Courier, monospace; letter-spacing: 1px; }
    .animate-fade-in { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    let cart = [];

    function addItem(type) {
        const selectId = (type === 'part') ? 'partSelect' : 'serviceSelect';
        const selectElement = document.getElementById(selectId);
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        if (!selectedOption.value) return;

        const itemId = selectedOption.value;
        const name = selectedOption.getAttribute('data-name');
        const price = parseInt(selectedOption.getAttribute('data-price')) || 0;
        const itemCode = selectedOption.getAttribute('data-code') || 'UNK-001'; 
        const stock = parseInt(selectedOption.getAttribute('data-stock')) || 0;

        const existingItem = cart.find(i => i.itemId === itemId);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ itemId, itemType: type, name, itemCode, pricePerUnit: price, quantity: 1, stock });
        }
        renderCart();
    }

    function generateQR() {
        const totalElement = document.getElementById("displayTotal").innerText;
        const cleanTotal = totalElement.replace(/[^0-9]/g, ''); 
        const qrContainer = document.getElementById("qrcode");
        
        if (cleanTotal === "0" || cleanTotal === "") {
            qrContainer.innerHTML = "<small class='text-muted'>Tambahkan item dulu</small>";
            return;
        }

        // Menggunakan Google Chart API (Sangat Stabil & Ringan)
        const qrData = "ACRMOTOR-PAYMENT-" + cleanTotal;
        const qrUrl = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(qrData)}&choe=UTF-8`;
        
        qrContainer.innerHTML = `<img src="${qrUrl}" class="img-fluid shadow-sm rounded-3" alt="QRIS QR Code">`;
    }

    function renderCart() {
        const tbody = document.querySelector("#cartTable tbody");
        const displayTotal = document.getElementById("displayTotal");
        tbody.innerHTML = "";
        let totalKotor = 0;

        if (cart.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted small italic">Belum ada item ditambahkan.</td></tr>';
            displayTotal.innerText = "Rp 0";
            return;
        }

        cart.forEach((item, index) => {
            const subtotal = item.quantity * item.pricePerUnit;
            totalKotor += subtotal;
            tbody.innerHTML += `
                <tr>
                    <td class="ps-4">
                        <div class="fw-bold text-dark">${item.name}</div>
                        <small class="badge bg-light text-muted border font-monospace" style="font-size:0.7rem">${item.itemCode}</small>
                    </td>
                    <td class="text-end text-muted">Rp ${item.pricePerUnit.toLocaleString('id-ID')}</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQty(${index}, ${item.quantity - 1})">-</button>
                            <input type="number" value="${item.quantity}" class="form-control text-center border-0 bg-light" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQty(${index}, ${item.quantity + 1})">+</button>
                        </div>
                    </td>
                    <td class="text-end fw-bold text-primary">Rp ${subtotal.toLocaleString('id-ID')}</td>
                    <td class="text-center">
                        <button type="button" onclick="removeItem(${index})" class="btn btn-link text-danger p-0"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });

        const discPercent = parseInt(document.getElementById("discountPercent").value) || 0;
        const discAmount = (totalKotor * discPercent) / 100;
        const finalTotal = totalKotor - discAmount;
        displayTotal.innerText = "Rp " + finalTotal.toLocaleString('id-ID');

        if (document.getElementById('paymentMethod').value === 'QRIS') {
            generateQR();
        }
    }

    function updateQty(index, val) {
        if (cart[index].itemType === 'part' && val > cart[index].stock) {
            alert('Melebihi stok yang tersedia!');
            return;
        }
        cart[index].quantity = Math.max(1, parseInt(val) || 1);
        renderCart();
    }

    function removeItem(index) {
        cart.splice(index, 1);
        renderCart();
    }

    // FUNGSI GENERATE QR (FIXED)
    function generateQR() {
        const totalElement = document.getElementById("displayTotal").innerText;
        const cleanTotal = totalElement.replace(/[^0-9]/g, ''); // Ambil angka saja
        const qrContainer = document.getElementById("qrcode-container");
        
        if (cleanTotal === "0" || cleanTotal === "") {
            qrContainer.innerHTML = "<small class='text-muted'>Pilih item terlebih dahulu</small>";
            return;
        }

        // URL Google Chart API
        const qrData = "ACRMOTOR-PAYMENT-" + cleanTotal;
        const qrUrl = `https://chart.googleapis.com/chart?chs=180x180&cht=qr&chl=${encodeURIComponent(qrData)}&choe=UTF-8`;
        
        // Render langsung menggunakan tag img
        qrContainer.innerHTML = `<img src="${qrUrl}" class="img-fluid shadow-sm rounded-3" alt="QRIS QR Code">`;
    }

    document.getElementById('paymentMethod').addEventListener('change', function() {
        const method = this.value;
        const detailArea = document.getElementById('paymentDetailArea');
        const bankInfo = document.getElementById('bankInfo');
        const qrisInfo = document.getElementById('qrisInfo');
        
        detailArea.classList.remove('d-none'); // Tampilkan container utama
        
        if (method === 'Cash') {
            detailArea.classList.add('d-none');
        } else if (method === 'Transfer') {
            bankInfo.classList.remove('d-none');
            qrisInfo.classList.add('d-none');
        } else if (method === 'QRIS') {
            qrisInfo.classList.remove('d-none');
            bankInfo.classList.add('d-none');
            generateQR(); // Menghasilkan QR Code saat diklik
        }
    });

    document.getElementById('transactionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (cart.length === 0) return alert("Tambahkan minimal 1 item!");

        const btn = document.getElementById('btnSubmit');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> MEMPROSES...';

        const totalKotor = cart.reduce((sum, item) => sum + (item.quantity * item.pricePerUnit), 0);
        const discPercent = parseInt(document.getElementById("discountPercent").value) || 0;
        const discAmount = (totalKotor * discPercent) / 100;

        const formData = {
            customer: document.getElementById('customerSelect').value,
            motorName: document.getElementById('motorSelect').value,
            vehicleLicense: document.getElementById('vehicleLicense').value,
            totalAmount: totalKotor,
            discount: discAmount,
            paymentMethod: document.getElementById('paymentMethod').value,
            notes: document.getElementById('notes').value || '-',
            assignedTo: document.getElementById('assignedTo').value || null,
            itemDetails: JSON.stringify(cart)
        };

        try {
            const response = await fetch('/api/transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            const result = await response.json();
            if (result.success) {
                alert('Transaksi Berhasil Disimpan!');
                window.location.href = '/transactions';
            } else {
                alert('Gagal: ' + result.message);
                btn.disabled = false;
                btn.innerHTML = 'SIMPAN TRANSAKSI';
            }
        } catch (err) { 
            alert('Kesalahan jaringan'); 
            btn.disabled = false;
            btn.innerHTML = 'SIMPAN TRANSAKSI';
        }
    });
</script>