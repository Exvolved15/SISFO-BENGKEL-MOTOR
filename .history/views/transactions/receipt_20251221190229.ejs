<!DOCTYPE html>
<html>
<head>
    <title>Struk - <%= transaction.invoiceNumber %></title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; width: 80mm; margin: 0 auto; font-size: 12px; }
        .text-center { text-align: center; }
        .line { border-bottom: 1px dashed #000; margin: 5px 0; }
        table { width: 100%; }
    </style>
</head>
<body onload="window.print()">
    <div class="text-center">
        <h3>SISFO BENGKEL</h3>
        <p>Invoice: <%= transaction.invoiceNumber %></p>
        <p><%= new Date(transaction.createdAt).toLocaleString('id-ID') %></p>
    </div>
    <div class="line"></div>
    <p>Pelanggan: <%= transaction.customerName %> (<%= transaction.vehicleLicense %>)</p>
    <div class="line"></div>
    <table>
        <% details.forEach(item => { %>
            <tr>
                <td colspan="2"><%= item.itemName %></td>
            </tr>
            <tr>
                <td><%= item.quantity %> x <%= item.pricePerUnit.toLocaleString('id-ID') %></td>
                <td align="right"><%= (item.quantity * item.pricePerUnit).toLocaleString('id-ID') %></td>
            </tr>
        <% }) %>
    </table>
    

    <div class="line"></div>

    <table style="margin-top: 10px;">
        <% details.forEach(item => { %>
            <tr>
                <td colspan="2" style="padding-top: 4px; font-weight: bold;"><%= item.itemName %></td>
            </tr>
            <tr>
                <td style="padding-bottom: 4px;">
                    <%= item.quantity %> x <%= item.pricePerUnit.toLocaleString('id-ID') %>
                </td>
                <td align="right" style="padding-bottom: 4px;">
                    <%= (item.quantity * item.pricePerUnit).toLocaleString('id-ID') %>
                </td>
            </tr>
        <% }) %>
    </table>

    <div class="line"></div>

    <% 
        // 1. Hitung ulang total kotor dari jumlah item jika totalAmount di DB 0
        let subtotal = details.reduce((acc, item) => acc + (item.quantity * item.pricePerUnit), 0);
        
        // 2. Ambil grandTotal dari database
        let bayar = transaction.grandTotal || 0;
        
        // 3. Hitung selisih sebagai diskon (jika grandTotal lebih kecil dari subtotal)
        let nominalDiskon = (subtotal > bayar) ? (subtotal - bayar) : (transaction.discount || 0);
        
        // 4. Hitung persentase
        let persen = subtotal > 0 ? Math.round((nominalDiskon / subtotal) * 100) : 0;
    <% %>

    <table>
        <tr>
            <td>Total:</td>
            <td align="right">Rp <%= subtotal.toLocaleString('id-ID') %></td>
        </tr>
        <tr>
            <td>Diskon (<%= persen %>%):</td>
            <td align="right">- Rp <%= nominalDiskon.toLocaleString('id-ID') %></td>
        </tr>
        <tr style="font-weight: bold; font-size: 14px;">
            <td style="padding-top: 8px;">TOTAL AKHIR:</td>
            <td align="right" style="padding-top: 8px;">Rp <%= bayar.toLocaleString('id-ID') %></td>
        </tr>
    </table>
    <div class="line"></div>
    <p class="text-center">Terima Kasih Atas Kunjungan Anda</p>
</body>
</html>