<!DOCTYPE html>
<html>
<head>
    <title>Struk - <%= transaction.invoiceNumber %></title>
    <style>
        /* Desain Struk Thermal 80mm */
        body { font-family: 'Courier New', Courier, monospace; width: 80mm; margin: 0 auto; font-size: 12px; color: #000; line-height: 1.2; }
        .text-center { text-align: center; }
        .line { border-bottom: 1px dashed #000; margin: 5px 0; }
        table { width: 100%; border-collapse: collapse; }
        .item-name { padding-top: 8px; font-weight: bold; display: block; text-transform: uppercase; }
        .item-details { padding-bottom: 4px; }
        .total-row { font-weight: bold; font-size: 13px; }
        .footer-msg { font-size: 10px; margin-top: 10px; }
        
        @media print {
            @page { margin: 0; }
            body { margin: 5mm; }
        }
    </style>
</head>
<body onload="window.print()">
    <div class="text-center">
        <h3 style="margin: 0 0 5px 0;">SISFO BENGKEL</h3>
        <p style="margin: 0;">No: <%= transaction.invoiceNumber %></p>
        <p style="margin: 0;"><%= new Date(transaction.createdAt).toLocaleString('id-ID') %></p>
    </div>

    <div class="line"></div>
    <p style="margin: 5px 0;">
        Plgn: <%= transaction.customerName %><br>
        Plat: <%= transaction.vehicleLicense %>
    </p>
    <div class="line"></div>

    <table>
        <% 
            // Inisialisasi hitung ulang subtotal jika data di DB tidak sinkron
            let subtotalHitungManual = 0; 
        %>
        <% details.forEach(item => { 
            let totalBaris = item.quantity * item.pricePerUnit;
            subtotalHitungManual += totalBaris;
        %>
            <tr>
                <td colspan="2" class="item-name"><%= item.itemName %></td>
            </tr>
            <tr>
                <td class="item-details">
                    <%= item.quantity %> x <%= item.pricePerUnit.toLocaleString('id-ID') %>
                </td>
                <td align="right" class="item-details">
                    <%= totalBaris.toLocaleString('id-ID') %>
                </td>
            </tr>
        <% }) %>
    </table>

    <div class="line"></div>

    <% 
        // LOGIKA PENYELAMAT DISKON (SINKRONISASI DATA)
        // 1. Ambil Grand Total (Apa yang dibayar)
        let bayarFinal = transaction.grandTotal || 0;

        // 2. Tentukan Subtotal (Total kotor sebelum diskon)
        // Jika totalAmount di DB nol/tidak valid, gunakan hasil hitung manual dari item
        let subtotalValid = (transaction.totalAmount > 0) ? transaction.totalAmount : subtotalHitungManual;

        // 3. Hitung Nominal Diskon (Selisih)
        let diskonNominal = (subtotalValid > bayarFinal) ? (subtotalValid - bayarFinal) : (transaction.discount || 0);

        // 4. Hitung Persentase Diskon secara otomatis
        let persenDiskon = subtotalValid > 0 ? Math.round((diskonNominal / subtotalValid) * 100) : 0;
    %>

    <table>
        <tr>
            <td>Total:</td>
            <td align="right">Rp <%= subtotalValid.toLocaleString('id-ID') %></td>
        </tr>
        <tr>
            <td>Diskon (<%= persenDiskon %>%):</td>
            <td align="right">- Rp <%= diskonNominal.toLocaleString('id-ID') %></td>
        </tr>
        <tr class="total-row">
            <td style="padding-top: 10px;">TOTAL AKHIR:</td>
            <td align="right" style="padding-top: 10px;">Rp <%= bayarFinal.toLocaleString('id-ID') %></td>
        </tr>
    </table>

    <div class="line"></div>
    <div class="text-center footer-msg">
        <p>Terima Kasih Atas Kunjungan Anda</p>
        <p>Barang/Jasa yang sudah dibeli tidak dapat<br>ditukar atau dikembalikan.</p>
    </div>
</body>
</html>