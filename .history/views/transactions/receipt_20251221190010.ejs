<!DOCTYPE html>
<html>
<head>
    <title>Struk - <%= transaction.invoiceNumber %></title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; width: 80mm; margin: 0 auto; font-size: 12px; }
        .text-center { text-align: center; }
        .line { border-bottom: 1px dashed #000; margin: 5px 0; }
        table { width: 100%; }
    </style>
</head>
<body onload="window.print()">
    <div class="text-center">
        <h3>SISFO BENGKEL</h3>
        <p>Invoice: <%= transaction.invoiceNumber %></p>
        <p><%= new Date(transaction.createdAt).toLocaleString('id-ID') %></p>
    </div>
    <div class="line"></div>
    <p>Pelanggan: <%= transaction.customerName %> (<%= transaction.vehicleLicense %>)</p>
    <div class="line"></div>
    <table>
        <% details.forEach(item => { %>
            <tr>
                <td colspan="2"><%= item.itemName %></td>
            </tr>
            <tr>
                <td><%= item.quantity %> x <%= item.pricePerUnit.toLocaleString('id-ID') %></td>
                <td align="right"><%= (item.quantity * item.pricePerUnit).toLocaleString('id-ID') %></td>
            </tr>
        <% }) %>
    </table>
    <div class="line"></div>
    <table>
        <% details.forEach(item => { %>
            <tr>
                <td colspan="2" style="padding-top: 5px;"><%= item.itemName %></td>
            </tr>
            <tr>
                <td><%= item.quantity %> x <%= item.pricePerUnit.toLocaleString('id-ID') %></td>
                <td align="right"><%= (item.quantity * item.pricePerUnit).toLocaleString('id-ID') %></td>
            </tr>
        <% }) %>
    </table>

    <div class="line"></div>

    <table>
        <tr>
            <td>Total:</td>
            <td align="right">Rp <%= transaction.totalAmount.toLocaleString('id-ID') %></td>
        </tr>
        <tr>
            <% 
                // Logika Perhitungan Persen & Potongan
                let totalKotor = transaction.totalAmount || 0;
                let potonganHarga = transaction.discount || 0;
                // Jika total akhir lebih kecil dari total kotor, hitung selisihnya sebagai diskon
                if (transaction.grandTotal < totalKotor && potonganHarga === 0) {
                    potonganHarga = totalKotor - transaction.grandTotal;
                }
                let persenDiskon = totalKotor > 0 ? Math.round((potonganHarga / totalKotor) * 100) : 0;
            %>
            <td>Diskon (<%= persenDiskon %>%):</td>
            <td align="right">- Rp <%= potonganHarga.toLocaleString('id-ID') %></td>
        </tr>
        <tr style="font-weight: bold; font-size: 14px;">
            <td style="padding-top: 5px;">TOTAL AKHIR:</td>
            <td align="right" style="padding-top: 5px;">Rp <%= transaction.grandTotal.toLocaleString('id-ID') %></td>
        </tr>
    </table>
    <div class="line"></div>
    <p class="text-center">Terima Kasih Atas Kunjungan Anda</p>
</body>
</html>