<div class="container py-4 animate-fade-in dashboard-wrapper">
    <div class="card border-0 shadow-sm mb-4 overflow-hidden rounded-4">
        <div class="card-body p-0">
            <div class="row g-0">
                <div class="col-md-8 p-4 d-flex align-items-center bg-white">
                    <div class="profile-avatar-container rounded-circle bg-primary d-flex align-items-center justify-content-center text-white shadow-sm overflow-hidden border border-4 border-light" 
                         style="width: 90px; height: 90px; min-width: 90px;">
                         <% if (user.profileImage) { %>
                            <img src="<%= user.profileImage %>?t=<%= Date.now() %>" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">
                        <% } else { %>
                            <span style="font-size: 2.5rem; font-weight: bold;"><%= user.name.charAt(0).toUpperCase() %></span>
                        <% } %>
                    </div>
                    
                    <div class="ms-4">
                        <h3 class="mb-1 fw-bold text-dark">Selamat Bertugas, <%= user.name %>!</h3>
                        <p class="text-muted mb-0 d-flex align-items-center flex-wrap">
                            <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-3 py-2 rounded-pill me-2">
                                <i class="fas fa-cash-register me-1"></i> Kasir / Front Desk
                            </span>
                            <span class="me-3"><i class="fas fa-map-location-dot text-info me-1"></i> Area: <%= user.department || 'Loket Pembayaran' %></span>
                            <span class="small"><i class="fas fa-calendar-alt text-warning me-1"></i> <%= new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></span>
                        </p>
                    </div>
                </div>
                
                <div class="col-md-4 bg-light p-4 d-flex align-items-center border-start border-opacity-10">
                    <div class="w-100 text-center">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small text-muted fw-bold text-uppercase">Status Loket</span>
                            <span class="badge bg-success rounded-pill px-3">BUKA / OPEN</span>
                        </div>
                        <hr class="my-2">
                        <div class="small text-muted mb-2">Otoritas: <span class="fw-bold text-dark">Billing & Transaction Entry</span></div>
                        <a href="/users/edit/<%= user._id %>" class="btn btn-sm btn-outline-primary w-100 rounded-pill mt-1">
                            <i class="fas fa-user-gear me-1"></i> Pengaturan Akun
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4 text-white">
        <div class="col-md-4">
            <div class="card bg-primary-gradient border-0 shadow-sm rounded-4 h-100 hover-elevate">
                <div class="card-body d-flex align-items-center">
                    <div class="icon-shape bg-white bg-opacity-25 rounded-3 p-3 me-3 text-white">
                        <i class="fas fa-cart-plus fa-2x"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-1">Transaksi Baru</h5>
                        <p class="small text-white-50 mb-2">Input servis & barang pelanggan</p>
                        <a href="/transactions/add" class="btn btn-light btn-sm fw-bold text-primary rounded-pill px-3">
                            Mulai Entry <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-emerald-gradient border-0 shadow-sm rounded-4 h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="icon-shape bg-white bg-opacity-25 rounded-3 p-3 me-3 text-white">
                        <i class="fas fa-file-invoice-dollar fa-2x"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-1">Total Hari Ini</h5>
                        <h3 class="fw-bold mb-0"><%= transactions ? transactions.length : 0 %></h3>
                        <p class="small text-white-50 mb-0">Faktur telah diterbitkan</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info-gradient border-0 shadow-sm rounded-4 h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="icon-shape bg-white bg-opacity-25 rounded-3 p-3 me-3 text-white">
                        <i class="fas fa-user-wrench fa-2x"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-1">Kapasitas Kerja</h5>
                        <% if (typeof mechanics !== 'undefined' && mechanics.length > 0) { 
                            let busy = mechanics.filter(m => m.status === 'kerja' || m.status === 'on_progress').length;
                        %>
                            <h3 class="fw-bold mb-0"><%= busy %> / <%= mechanics.length %></h3>
                        <% } else { %>
                            <h3 class="fw-bold mb-0">0 / 0</h3>
                        <% } %>
                        <p class="small text-white-50 mb-0">Mekanik aktif di bengkel</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden h-100">
                <div class="card-header bg-dark text-white py-3">
                    <h6 class="mb-0 fw-bold d-flex align-items-center">
                        <i class="fas fa-clock-rotate-left me-2 text-warning"></i> Monitoring Antrian Servis
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr class="small text-uppercase fw-bold">
                                    <th class="ps-4">No. Faktur</th>
                                    <th>Pelanggan / Unit</th>
                                    <th>Mekanik</th>
                                    <th>Status</th>
                                    <th class="text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (transactions && transactions.length > 0) { %>
                                    <% transactions.slice(0, 10).forEach(trx => { %>
                                    <tr>
                                        <td class="ps-4">
                                            <span class="fw-bold text-primary"><%= trx.invoiceNumber %></span>
                                        </td>
                                        <td>
                                            <div class="fw-bold text-dark"><%= trx.customerName %></div>
                                            <small class="badge bg-light text-muted border px-2 py-1" style="font-size: 0.7rem;">
                                                <i class="fas fa-motorcycle me-1"></i> <%= trx.motorName %> (<%= trx.vehicleLicense %>)
                                            </small>
                                        </td>
                                        <td>
                                            <div class="small fw-bold"><i class="fas fa-user-cog text-muted me-1"></i><%= trx.mechanicName %></div>
                                        </td>
                                        <td>
                                            <% let s = trx.status ? trx.status.toLowerCase() : 'proses'; %>
                                            <% if (s === 'completed' || s === 'selesai' || s === 'lunas') { %>
                                                <span class="badge bg-success-soft text-success rounded-pill px-3">
                                                    <i class="fas fa-check-circle me-1"></i>Selesai
                                                </span>
                                            <% } else { %>
                                                <span class="badge bg-warning-soft text-warning rounded-pill px-3">
                                                    <i class="fas fa-spinner fa-spin me-1"></i>Proses
                                                </span>
                                            <% } %>
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group shadow-sm rounded-pill overflow-hidden">
                                                <% if (s !== 'completed' && s !== 'selesai' && s !== 'lunas') { %>
                                                    <button onclick="markAsDone('<%= trx._id %>')" class="btn btn-sm btn-success border-0 px-3" title="Tandai Selesai">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                <% } %>
                                                <a href="/api/transactions/print/<%= trx._id %>" target="_blank" class="btn btn-sm btn-dark border-0 px-3" title="Cetak Resi">
                                                    <i class="fas fa-print"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr><td colspan="5" class="text-center py-5 text-muted small italic">Belum ada transaksi terekam hari ini.</td></tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden h-100">
                <div class="card-header bg-secondary text-white py-3">
                    <h6 class="mb-0 fw-bold d-flex align-items-center">
                        <i class="fas fa-tools me-2"></i> Ketersediaan Mekanik
                    </h6>
                </div>
                <div class="card-body bg-light bg-opacity-50">
                    <div class="row g-3">
                        <% if (typeof mechanics !== 'undefined' && mechanics.length > 0) { %>
                            <% mechanics.forEach(mech => { %>
                                <div class="col-12">
                                    <% 
                                        let statusColor = 'danger'; 
                                        let statusIcon = 'fa-circle-xmark';
                                        if (mech.status === 'kerja' || mech.status === 'on_progress') { statusColor = 'warning'; statusIcon = 'fa-hammer fa-spin'; }
                                        if (mech.status === 'nganggur' || !mech.status) { statusColor = 'success'; statusIcon = 'fa-circle-check'; }
                                    %>
                                    <div class="card border-0 shadow-sm rounded-3 hover-elevate">
                                        <div class="card-body d-flex justify-content-between align-items-center py-3">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm bg-<%= statusColor %>-soft text-<%= statusColor %> rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                    <i class="fas <%= statusIcon %>"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0 fw-bold text-dark"><%= mech.name %></h6>
                                                    <small class="text-muted"><%= mech.department || 'Workshop' %></small>
                                                </div>
                                            </div>
                                            <% if (mech.status === 'nganggur' || !mech.status) { %>
                                                <span class="badge bg-success-soft text-success">READY</span>
                                            <% } else { %>
                                                <span class="badge bg-warning-soft text-warning">BUSY</span>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="col-12 text-center py-4">
                                <i class="fas fa-user-slash fa-3x text-muted opacity-25 mb-3"></i>
                                <p class="text-muted small italic mb-0">Belum ada mekanik yang login atau terdaftar.</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* KASIR SPECIFIC GRADIENTS */
    .bg-primary-gradient { background: linear-gradient(135deg, #0d6efd, #0046b8); }
    .bg-emerald-gradient { background: linear-gradient(135deg, #2ecc71, #1b7e43); }
    .bg-info-gradient { background: linear-gradient(135deg, #0dcaf0, #0aa2c0); }
    
    .bg-success-soft { background-color: rgba(46, 204, 113, 0.15); }
    .bg-warning-soft { background-color: rgba(255, 193, 7, 0.15); }
    .bg-primary-soft { background-color: rgba(13, 110, 253, 0.15); }
    .bg-danger-soft { background-color: rgba(220, 53, 69, 0.15); }

    .hover-elevate { transition: all 0.3s ease; }
    .hover-elevate:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1) !important; }

    .animate-fade-in { animation: fadeIn 0.8s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .btn-group .btn { border-radius: 0; }
    .btn-group .btn:first-child { border-top-left-radius: 50px; border-bottom-left-radius: 50px; }
    .btn-group .btn:last-child { border-top-right-radius: 50px; border-bottom-right-radius: 50px; }
</style>

<script>
async function markAsDone(id) {
    if(!confirm('Tandai transaksi ini sebagai selesai dan lunas?')) return;
    try {
        const response = await fetch(`/api/transactions/update-status/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload(); 
        } else {
            alert('Gagal: ' + result.message);
        }
    } catch (err) {
        alert('Kesalahan koneksi ke server.');
    }
}
</script>