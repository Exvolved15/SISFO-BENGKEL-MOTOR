<div class="container mt-4">
    <h2>Selamat Datang, <%= user.name %></h2>
    <hr>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white shadow">
                <div class="card-body">
                    <h5>Transaksi Baru</h5>
                    <p>Input servis pelanggan baru.</p>
                    <a href="/transactions/add" class="btn btn-light btn-sm">Buka Form</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white shadow">
                <div class="card-body">
                    <h5>Total Transaksi</h5>
                    <h3><%= transactions.length %></h3>
                    <p class="mb-0">Transaksi tercatat hari ini.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white shadow">
                <div class="card-body">
                    <h5>Mekanik Aktif</h5>
                    <% if (typeof mechanics !== 'undefined' && mechanics.length > 0) { %>
                        <h3>
                            <%= mechanics.filter(m => m.status === 'kerja').length %> / <%= mechanics.length %>
                        </h3>
                    <% } else { %>
                        <h3>0 / 0</h3>
                    <% } %>
                    <p class="mb-0">Mekanik sedang menangani unit.</p>
                </div>
            </div>
        </div>
        
        <div class="card shadow">
            <div class="card-header bg-secondary text-white">
                <i class="fas fa-tools me-2"></i>Status & Pekerjaan Mekanik
            </div>
            <div class="card-body">
                <div class="row">
                    <% if (typeof mechanics !== 'undefined' && mechanics.length > 0) { %>
                        <% mechanics.forEach(mech => { %>
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-start border-4 <%= mech.status === 'nganggur' ? 'border-danger' : (mech.status === 'kerja' ? 'border-warning' : 'border-success') %>">
                                    <div class="card-body">
                                        <h6 class="card-title mb-1"><%= mech.name %></h6>
                                        </div>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="col-12 text-center py-3">
                            <p class="text-muted">Tidak ada data mekanik terdaftar.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header bg-dark text-white">
            <i class="fas fa-history me-2"></i>Riwayat Transaksi Terakhir
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Invoice</th>
                        <th>Pelanggan</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (transactions && transactions.length > 0) { %>
                        <% transactions.forEach(trx => { %>
                        <tr>
                            <td><strong><%= trx.invoiceNumber %></strong></td>
                            <td><%= trx.customerName || (trx.customer ? trx.customer.name : 'N/A') %> (<%= trx.vehicleLicense %>)</td>
                            <td>
                                <% if (trx.status === 'completed' || trx.status === 'Selesai') { %>
                                    <span class="badge bg-success">Selesai</span>
                                <% } else { %>
                                    <span class="badge bg-warning text-dark">Proses</span>
                                    <button onclick="markAsDone('<%= trx._id %>')" class="btn btn-sm btn-outline-success ms-2">
                                        Selesaikan
                                    </button>
                                <% } %>
                            </td>
                            <td>
                                <% if (trx.status === 'completed' || trx.status === 'Selesai') { %>
                                    <span class="badge bg-success">Selesai</span>
                                <% } else { %>
                                    <span class="badge bg-warning text-dark">Proses</span>
                                    <button onclick="markAsDone('<%= trx._id %>')" class="btn btn-sm btn-outline-success ms-2">
                                        Selesaikan
                                    </button>
                                <% } %>
                                <a href="/transactions/print/<%= trx._id %>" target="_blank" class="btn btn-sm btn-dark">Resi</a>
                            </td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr><td colspan="4" class="text-center">Belum ada transaksi.</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function markAsDone(id) {
            if(confirm('Tandai transaksi ini sebagai selesai? Pelanggan sudah bayar?')) {
                try {
                    const response = await fetch(`/api/transactions/update-status/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'completed' })
                    });
        
                    const result = await response.json();
                    if (result.success) {
                        alert('Transaksi Selesai!');
                        window.location.reload(); // Refresh halaman untuk melihat perubahan badge
                    } else {
                        alert('Gagal update: ' + result.error);
                    }
                } catch (err) {
                    alert('Koneksi server gagal');
                }
            }
        }
        </script>

    <div class="card shadow">
        <div class="card-header bg-secondary text-white">
            <i class="fas fa-tools me-2"></i>Status & Pekerjaan Mekanik
        </div>
        <div class="card-body">
            <div class="row">
                <% mechanics.forEach(mech => { %>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-start border-4 <%= mech.status === 'nganggur' ? 'border-danger' : (mech.status === 'kerja' ? 'border-warning' : 'border-success') %>">
                            <div class="card-body">
                                <h6 class="card-title mb-1"><%= mech.name %></h6>
                                
                                <% if (mech.status === 'Tidak Bekerja') { %>
                                    <span class="badge bg-danger mb-2">Tidak Ada Kerjaaan</span>
                                    <p class="text-muted small">Tersedia untuk tugas baru.</p>
                                <% } else if (mech.status === 'kerja') { %>
                                    <span class="badge bg-warning text-dark mb-2">Sedang Mengerjakan</span>
                                    <p class="mb-0 small"><strong>Unit:</strong> <%= mech.currentJob || 'Sedang Proses...' %></p>
                                <% } else { %>
                                    <span class="badge bg-success mb-2">Selesai</span>
                                    <p class="text-muted small">Baru saja menyelesaikan tugas.</p>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>
    </div>
</div>