<div class="container mt-4">
    <h2>Selamat Datang, <%= user.name %></h2>
    <hr>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white shadow h-100">
                <div class="card-body">
                    <h5>Transaksi Baru</h5>
                    <p>Input servis pelanggan baru.</p>
                    <a href="/transactions/add" class="btn btn-light btn-sm">Buka Form</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white shadow h-100">
                <div class="card-body">
                    <h5>Total Transaksi</h5>
                    <h3><%= transactions.length %></h3>
                    <p class="mb-0">Transaksi hari ini.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white shadow h-100">
                <div class="card-body">
                    <h5>Mekanik Sibuk</h5>
                    <% if (typeof mechanics !== 'undefined' && mechanics.length > 0) { %>
                        <h3>
                            <%= mechanics.filter(m => m.status === 'kerja' || m.status === 'on_progress').length %> / <%= mechanics.length %>
                        </h3>
                    <% } else { %>
                        <h3>0 / 0</h3>
                    <% } %>
                    <p class="mb-0">Mekanik sedang menangani unit.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <span><i class="fas fa-history me-2"></i>Riwayat Transaksi Terakhir</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Invoice</th>
                            <th>Pelanggan</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (transactions && transactions.length > 0) { %>
                            <% transactions.forEach(trx => { %>
                            <tr>
                                <td><strong><%= trx.invoiceNumber %></strong></td>
                                <td><%= trx.customerName || (trx.customer ? trx.customer.name : 'N/A') %> (<%= trx.vehicleLicense %>)</td>
                                <td>
                                    <% if (trx.status === 'completed') { %>
                                        <span class="badge bg-success">Selesai</span>
                                    <% } else { %>
                                        <span class="badge bg-warning text-dark">Proses</span>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <% if (trx.status && trx.status.toLowerCase() === 'completed') { %>
                                            <span class="badge bg-success">Selesai</span>
                                        <% } else { %>
                                            <span class="badge bg-warning text-dark">Proses</span>
                                            <button onclick="markAsDone('<%= trx._id %>')" class="btn btn-sm btn-outline-success ms-2">Selesaikan</button>
                                        <% } %>
                                        <a href="/transactions/print/<%= trx._id %>" target="_blank" class="btn btn-sm btn-dark"><i class="fas fa-print"></i> Resi</a>
                                    </div>
                                </td>
                            </tr>
                            <% }) %>
                        <% } else { %>
                            <tr><td colspan="4" class="text-center">Belum ada transaksi.</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header bg-secondary text-white">
            <i class="fas fa-tools me-2"></i>Status & Beban Kerja Mekanik
        </div>
        <div class="card-body">
            <div class="row">
                <% if (typeof mechanics !== 'undefined' && mechanics.length > 0) { %>
                    <% mechanics.forEach(mech => { %>
                        <div class="col-md-4 mb-3">
                            <% 
                                // Sinkronisasi warna status
                                let borderClass = 'border-danger'; // Nganggur
                                if (mech.status === 'kerja' || mech.status === 'on_progress') borderClass = 'border-warning';
                                if (mech.status === 'completed' || mech.status === 'selesai') borderClass = 'border-success';
                            %>
                            <div class="card h-100 border-start border-4 <%= borderClass %> shadow-sm">
                                <div class="card-body">
                                    <h6 class="card-title fw-bold"><%= mech.name %></h6>
                                    
                                    <% if (mech.status === 'nganggur' || !mech.status || mech.status === 'Tidak Bekerja') { %>
                                        <span class="badge bg-danger mb-2">Tersedia</span>
                                        <p class="text-muted small mb-0">Belum ada tugas hari ini.</p>
                                    <% } else if (mech.status === 'kerja' || mech.status === 'on_progress') { %>
                                        <span class="badge bg-warning text-dark mb-2">Sedang Mengerjakan</span>
                                        <p class="mb-0 small text-truncate"><strong>Unit:</strong> <%= mech.currentJob || 'Servis Berjalan' %></p>
                                    <% } else { %>
                                        <span class="badge bg-success mb-2">Selesai</span>
                                        <p class="text-muted small mb-0">Tugas terakhir selesai.</p>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <div class="col-12 text-center py-3">
                        <p class="text-muted">Mekanik belum disinkronkan ke dashboard.</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script>
async function markAsDone(id) {
    if(confirm('Tandai transaksi ini sebagai selesai?')) {
        try {
            const response = await fetch(`/api/transactions/update-status/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();
            if (result.success) {
                alert('Status Berhasil Diperbarui!');
                window.location.reload(); 
            } else {
                alert('Gagal: ' + result.message);
            }
        } catch (err) {
            alert('Terjadi kesalahan koneksi.');
        }
    }
}
</script>